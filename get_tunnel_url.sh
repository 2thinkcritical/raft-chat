#!/bin/bash

echo "๐ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ Cloudflared ััะฝะฝะตะปั..."
echo "โณ ะญัะพ ะผะพะถะตั ะทะฐะฝััั 10-30 ัะตะบัะฝะด..."

# ะะดะตะผ ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะฐ
sleep 5

# ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะฐ
if ! docker ps | grep -q chat-cloudflared; then
    echo "โ ะะพะฝัะตะนะฝะตั cloudflared ะฝะต ะทะฐะฟััะตะฝ"
    exit 1
fi

echo "โ ะะพะฝัะตะนะฝะตั cloudflared ะทะฐะฟััะตะฝ"
echo "๐ ะัะตะผ URL ะฒ ะปะพะณะฐั..."

# ะะดะตะผ ะฟะพัะฒะปะตะฝะธั URL ะฒ ะปะพะณะฐั (ะผะฐะบัะธะผัะผ 60 ัะตะบัะฝะด)
for i in {1..60}; do
    URL=$(docker logs chat-cloudflared 2>&1 | grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare\.com' | tail -1)
    
    if [ ! -z "$URL" ]; then
        echo ""
        echo "๐ ะัะฑะปะธัะฝัะน URL ะฝะฐะนะดะตะฝ!"
        echo "๐ $URL"
        echo ""
        echo "๐ ะกะบะพะฟะธััะนัะต ััั ัััะปะบั ะดะปั ะดะพัััะฟะฐ ะบ ะฟัะธะปะพะถะตะฝะธั"
        echo "๐ HTTPS ะฒะบะปััะตะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ"
        echo "๐ ะะพัััะฟะฝะพ ะธะท ะปัะฑะพะน ัะพัะบะธ ะผะธัะฐ"
        exit 0
    fi
    
    echo -n "."
    sleep 1
done

echo ""
echo "โ URL ะฝะต ะฝะฐะนะดะตะฝ ะฒ ะปะพะณะฐั"
echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ ะฒัััะฝัั:"
echo "   docker logs chat-cloudflared" 